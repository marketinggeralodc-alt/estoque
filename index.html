<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pedidos v3 - OdontoCompany</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ícones (para o histórico) -->
    <script src="https://unpkg.com/lucide-react@0.395.0/dist/umd/lucide.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; } /* Esconde todas as páginas por padrão */
        
        #loading-spinner {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid #f3f3ff; border-top: 4px solid #3b82f6;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #custom-alert {
            position: fixed; top: 20px; right: 20px;
            padding: 1rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000; display: none; max-width: 300px;
            color: white;
        }
        
        /* Estilo para o accordion de histórico */
        details summary {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details summary:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        details .history-content {
            padding: 1.5rem;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        details summary .chevron {
            transition: transform 0.2s;
        }
        details[open] summary .chevron {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 max-w-6xl">

        <!-- Banner do Modo de Simulação -->
        <div id="simulation-banner" class="hidden text-center text-sm bg-yellow-200 text-yellow-800 p-2 rounded-md shadow-sm mb-4">
            <strong>Modo de Simulação:</strong> Os dados não serão salvos no banco de dados.
        </div>

        <div id="loading-spinner"><div class="spinner"></div></div>
        <div id="custom-alert"><p id="custom-alert-message"></p></div>

        <!-- Etapa 1: Seleção da Filial -->
        <div id="page-select-filial" class="page min-h-screen flex flex-col justify-center items-center">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
                <h1 class="text-3xl font-bold text-blue-600 mb-6">Controle de Pedidos</h1>
                <p class="text-gray-600 mb-8">Selecione sua filial para continuar:</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button onclick="showLogin('Patos de Minas')" class="filial-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg shadow transition duration-300">Patos de Minas</button>
                    <button onclick="showLogin('São Gotardo')" class="filial-button bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg shadow transition duration-300">São Gotardo</button>
                    <button onclick="showLogin('Ibiá')" class="filial-button bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-4 px-6 rounded-lg shadow transition duration-300">Ibiá</button>
                    <button onclick="showLogin('Guarda dos Ferreiros')" class="filial-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-4 px-6 rounded-lg shadow transition duration-300">Guarda dos Ferreiros</button>
                </div>
            </div>
        </div>
        
        <!-- Etapa 1.5: Login com Senha (Novo) -->
        <div id="page-login" class="page min-h-screen flex flex-col justify-center items-center">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Login</h2>
                <p class="text-gray-600 mb-2">Filial:</p>
                <h1 id="login-filial-name" class="text-3xl font-semibold text-blue-600 mb-8"></h1>
                
                <div class="space-y-4">
                    <label for="login-password-input" class="block text-sm font-medium text-gray-700 sr-only">Senha</label>
                    <input type="password" id="login-password-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm text-center text-lg" placeholder="Digite sua senha">
                    
                    <button onclick="handleLogin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                        Entrar
                    </button>
                    <button onclick="logout()" class="w-full text-sm text-gray-500 hover:text-red-600 hover:underline">
                        Voltar (Trocar Filial)
                    </button>
                </div>
            </div>
        </div>

        <!-- Etapa 2: Painel de Controle (com Histórico) -->
        <div id="page-main-menu" class="page">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-3xl mx-auto">
                <p class="text-xl font-semibold text-gray-800 mb-2">Filial:</p>
                <h1 id="filial-name-menu" class="text-4xl font-bold text-blue-600 mb-8"></h1>
                <p class="text-gray-600 mb-8">O que você gostaria de fazer?</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Opção A: Gerenciar Estoque -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm flex flex-col">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gerenciar Estoque</h2>
                        <p class="text-gray-600 mb-6 flex-grow">Atualize a quantidade de produtos em estoque e o mínimo mensal.</p>
                        <button onclick="renderPage('page-update-stock')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                            Atualizar Estoque
                        </button>
                    </div>
                    
                    <!-- Opção B: Fazer Pedido -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm flex flex-col">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Fazer Pedido</h2>
                        <p class="text-gray-600 mb-6 flex-grow">Veja as sugestões de compra e crie um novo pedido.</p>
                        <button onclick="renderPage('page-order-form')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                            Fazer Pedido
                        </button>
                    </div>
                    
                    <!-- Opção C: Histórico de Pedidos (Novo) -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm flex flex-col">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Histórico</h2>
                        <p class="text-gray-600 mb-6 flex-grow">Veja todos os pedidos enviados anteriormente por esta filial.</p>
                        <button onclick="renderPage('page-history')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                            Ver Histórico
                        </button>
                    </div>
                </div>
                
                <div class="mt-12">
                    <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-600 hover:underline">
                        Trocar Filial (Sair)
                    </button>
                </div>
            </div>
        </div>

        <!-- Etapa 3A: Gerenciar Estoque -->
        <div id="page-update-stock" class="page">
            <div class="bg-white p-4 sm:p-8 rounded-lg shadow-xl">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 mb-6">Gerenciar Estoque - <span id="filial-name-stock"></span></h1>
                <p class="text-gray-600 mb-6 hidden sm:block">Atualize o "Mínimo Mensal" (ideal) e o "Estoque Atual" (real).</p>
                
                <div class="mb-6 sticky top-4 bg-white py-4 flex flex-col-reverse sm:flex-row justify-between items-center z-10 shadow-sm rounded-lg p-4 gap-4">
                    <button onclick="goToPage('page-main-menu')" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg shadow transition duration-300">
                        Voltar ao Menu
                    </button>
                    <button onclick="saveStockUpdates()" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow transition duration-300">
                        Salvar Alterações
                    </button>
                </div>

                <div id="stock-list-container" class="space-y-6">
                    <!-- Lista de produtos para edição de estoque -->
                </div>
            </div>
        </div>

        <!-- Etapa 3B: Formulário de Pedido -->
        <div id="page-order-form" class="page">
            <div class="bg-white p-4 sm:p-8 rounded-lg shadow-xl">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 mb-6">Fazer Pedido - <span id="filial-name-order"></span></h1>
                <p class="text-gray-600 mb-6 hidden sm:block">O sistema sugere a compra (Mínimo - Estoque). Ajuste a "Qtd. a Pedir" conforme necessário.</p>
                
                 <div class="mb-6 sticky top-4 bg-white py-4 flex flex-col-reverse sm:flex-row justify-between items-center z-10 shadow-sm rounded-lg p-4 gap-4">
                    <button onclick="goToPage('page-main-menu')" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg shadow transition duration-300">
                        Voltar ao Menu
                    </button>
                    <button onclick="reviewOrder()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow transition duration-300">
                        Revisar Pedido
                    </button>
                </div>

                <div id="order-list-container" class="space-y-6">
                    <!-- Lista de produtos para pedido -->
                </div>
                
                <div class="mt-8 pt-6 border-t">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Produtos Extras</h2>
                    <p class="text-gray-600 mb-4">Se precisar de algo que não está na lista, descreva abaixo.</p>
                    <textarea id="extra-items-textarea" class="w-full p-3 border border-gray-300 rounded-md shadow-sm h-32" placeholder="Ex: 2 caixas de papel toalha..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Etapa 3C: Histórico de Pedidos (Novo) -->
        <div id="page-history" class="page">
            <div class="bg-white p-4 sm:p-8 rounded-lg shadow-xl">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 mb-6">Histórico de Pedidos - <span id="filial-name-history"></span></h1>
                <p class="text-gray-600 mb-6">Aqui estão os últimos pedidos feitos por esta filial.</p>
                
                <div class="mb-6">
                    <button onclick="goToPage('page-main-menu')" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg shadow transition duration-300">
                        Voltar ao Menu
                    </button>
                </div>

                <div id="history-list-container" class="space-y-4">
                    <!-- Lista de pedidos anteriores -->
                </div>
            </div>
        </div>


        <!-- Etapa 4: Revisão do Pedido -->
        <div id="page-review" class="page">
             <div class="bg-white p-4 sm:p-8 rounded-lg shadow-xl">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 mb-6 border-b pb-4">Revisão do Pedido</h1>
                <p class="text-gray-600 mb-4">Confirme os itens e quantidades antes de enviar.</p>
                <p class="text-lg font-semibold text-gray-800 mb-4">Filial: <span id="review-filial-name" class="text-blue-600"></span></p>
                
                <h2 class="text-xl font-semibold text-gray-800 mt-6 mb-2">Itens do Catálogo:</h2>
                <div id="review-summary" class="space-y-2 max-h-96 overflow-y-auto pr-2 border rounded-md p-4">
                    <!-- Resumo do pedido -->
                </div>
                
                <h2 class="text-xl font-semibold text-gray-800 mt-6 mb-2">Itens Extras:</h2>
                <div id="review-extra-items" class="p-4 bg-gray-100 rounded-md whitespace-pre-wrap min-h-[50px]">
                    <!-- Itens extras -->
                </div>
                
                <div class="mt-8 flex flex-col-reverse sm:flex-row justify-between gap-4">
                    <button onclick="goToPage('page-order-form')" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">Voltar e Editar</button>
                    <button onclick="submitOrder()" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">Confirmar e Enviar</button>
                </div>
            </div>
        </div>

        <!-- Etapa 5: Sucesso -->
        <div id="page-success" class="page">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-lg mx-auto">
                <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h1 class="text-3xl font-bold text-green-600 mb-4">Pedido Enviado!</h1>
                <p class="text-gray-600 mb-8">O seu pedido foi salvo e a administração notificada.</p>
                <button onclick="goToPage('page-main-menu')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition duration-300">
                    Voltar ao Menu
                </button>
            </div>
        </div>

    </div>

    <!-- Script principal da aplicação -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração ---
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- SENHAS (Novo) ---
        // Em um app real, isso viria de um DB seguro, mas para "prevenir acidentes"
        // como você pediu, isso funciona perfeitamente.
        const FILIAL_PASSWORDS = {
            'Patos de Minas': '123',
            'São Gotardo': '123',
            'Ibiá': '123',
            'Guarda dos Ferreiros': '123'
        };

        let app, db, auth, userId;
        let isAuthReady = false;
        let isInSimulationMode = false;

        // --- Estado da Aplicação ---
        let currentPage = 'page-select-filial';
        let selectedFilial = '';
        let filialInventory = {}; // { "AGULHA CURTA": { minimo: 2, estoque: 0 }, ... }
        let currentOrder = {}; // { "AGULHA CURTA": 5, ... }
        let currentExtraItems = "";
        
        // --- Base de Dados de Produtos (CATÁLOGO MESTRE) ---
        const allProducts = [
            { "descricao": "Ácido Fluorídrico", "categoria": "DENTÍSTICA", "marca": "ALLPRIME" },
            { "descricao": "Ácido Fosfórico 37%", "categoria": "DENTÍSTICA", "marca": "ALLPRIME" },
            { "descricao": "Acrílica AltoPolimerizante 61", "categoria": "DENTÍSTICA", "marca": "DENCOR" },
            { "descricao": "AGULHA CURTA", "categoria": "DIVERSOS", "marca": "ALLPRIME" },
            { "descricao": "AGULHA LONGA", "categoria": "DIVERSOS", "marca": "ALLPRIME" },
            { "descricao": "ALGINATO ALVAGEL", "categoria": "DIVERSOS", "marca": "DENTSPLY" },
            { "descricao": "ALGODAO ROLETE", "categoria": "DIVERSOS", "marca": "SSPLUS" },
            { "descricao": "ALPHACAINA", "categoria": "CIRURGIA", "marca": "DFL" },
            { "descricao": "ANESTÉSICO ARTICAINE", "categoria": "CIRURGIA", "marca": "DFL" },
            { "descricao": "BENSONTOP", "categoria": "CIRURGIA", "marca": "DFL" },
            { "descricao": "FIO DE SUTURA 3-0 NLON", "categoria": "CIRURGIA", "marca": "PROCARE" },
            { "descricao": "LIDOSTESIN", "categoria": "CIRURGIA", "marca": "SSPLUS" },
            { "descricao": "SORO FISIOLOGICO 500ML", "categoria": "CIRURGIA", "marca": "-" },
            { "descricao": "FIO NITI 12 SUPERIOR", "categoria": "ORTODONTIA", "marca": "MORELLI" },
            { "descricao": "FIO NITI 14 INFERIOR", "categoria": "ORTODONTIA", "marca": "MORELLI" },
            { "descricao": "FIO AÇO 16 SUPERIOR", "categoria": "ORTODONTIA", "marca": "MORELLI" },
            { "descricao": "ELASTICO INTRAORAL MÉDIO 1/8", "categoria": "ORTODONTIA", "marca": "MORELLI" },
            { "descricao": "BRACKET ROTH 0,22", "categoria": "ORTODONTIA", "marca": "MORELLI" }
        ].sort((a, b) => a.descricao.localeCompare(b.descricao));


        // --- Funções Auxiliares ---
        function showLoading(show) {
            document.getElementById('loading-spinner').style.display = show ? 'flex' : 'none';
        }

        function showAlert(message, type = 'error', duration = 3000) {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('custom-alert-message');
            alertMessage.innerText = message;
            
            if (type === 'success') {
                alertBox.style.backgroundColor = '#10b981'; // green-500
            } else {
                alertBox.style.backgroundColor = '#ef4444'; // red-500
            }
            
            alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, duration);
        }

        window.goToPage = (pageId) => {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
            currentPage = pageId;
            window.scrollTo(0, 0);
            
            // Carrega ícones Lucide se existirem na página
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function groupProducts(productList) {
            return productList.reduce((acc, product) => {
                const category = product.categoria || 'DIVERSOS';
                if (!acc[category]) acc[category] = [];
                acc[category].push(product);
                return acc;
            }, {});
        }
        
        function formatFirebaseDate(fbTimestamp) {
            if (!fbTimestamp) return "Data inválida";
            // Em simulação, o 'criadoEm' será um Date. No Firebase, será um Timestamp.
            const date = (fbTimestamp.toDate) ? fbTimestamp.toDate() : new Date(fbTimestamp);
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }


        // --- Funções de Login / Logout ---
        
        window.showLogin = (filial) => {
            selectedFilial = filial;
            document.getElementById('login-filial-name').innerText = filial;
            document.getElementById('login-password-input').value = "";
            goToPage('page-login');
        }
        
        window.handleLogin = () => {
            const input = document.getElementById('login-password-input');
            const password = input.value;
            
            if (password === FILIAL_PASSWORDS[selectedFilial]) {
                showAlert('Login bem-sucedido!', 'success', 2000);
                input.value = ""; // Limpa senha
                loadFilialData(); // Função principal de carregamento
            } else {
                showAlert('Senha incorreta. Tente novamente.', 'error');
                input.value = "";
            }
        }
        
        window.logout = () => {
            selectedFilial = '';
            filialInventory = {};
            currentOrder = {};
            currentExtraItems = "";
            document.getElementById('login-password-input').value = "";
            goToPage('page-select-filial');
        }

        // --- Funções Principais da Aplicação ---

        // Etapa 2: Carrega dados da filial (APÓS LOGIN)
        async function loadFilialData() {
            showLoading(true);
            
            document.getElementById('filial-name-menu').innerText = selectedFilial;
            document.getElementById('filial-name-stock').innerText = selectedFilial;
            document.getElementById('filial-name-order').innerText = selectedFilial;
            document.getElementById('filial-name-history').innerText = selectedFilial;

            // Limpa dados de pedido anterior
            currentOrder = {};
            currentExtraItems = "";
            document.getElementById('extra-items-textarea').value = "";

            const inventoryDocPath = `artifacts/${appId}/public/data/inventarios/${selectedFilial}`;
            
            // Lógica de Simulação
            if (isInSimulationMode) {
                console.log("SIMULAÇÃO: Carregando dados da filial " + selectedFilial);
                const localData = localStorage.getItem(`sim_inventory_${selectedFilial}`);
                if (localData) {
                    filialInventory = JSON.parse(localData);
                } else {
                    filialInventory = {};
                    allProducts.forEach(prod => {
                        filialInventory[prod.descricao] = { minimo: 1, estoque: 0 };
                    });
                }
                setTimeout(() => {
                    showLoading(false);
                    goToPage('page-main-menu');
                }, 500);
                return;
            }

            // Lógica Real do Firebase
            if (!isAuthReady || !db) {
                showAlert("Erro de conexão com o banco de dados.");
                showLoading(false);
                return;
            }

            try {
                const docRef = doc(db, inventoryDocPath);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    filialInventory = docSnap.data().produtos || {};
                } else {
                    console.log("Primeiro login da filial, criando inventário inicial...");
                    filialInventory = {};
                    allProducts.forEach(prod => {
                        filialInventory[prod.descricao] = { minimo: 1, estoque: 0 }; 
                    });
                    await setDoc(docRef, { 
                        filial: selectedFilial,
                        produtos: filialInventory,
                        criadoEm: Timestamp.now()
                    });
                }
                
                // Garante que o inventário local tenha todos os produtos do catálogo mestre
                let needsUpdate = false;
                allProducts.forEach(prod => {
                    if (!filialInventory[prod.descricao]) {
                        filialInventory[prod.descricao] = { minimo: 0, estoque: 0 };
                        needsUpdate = true;
                    }
                });
                if (needsUpdate) {
                    await setDoc(docRef, { produtos: filialInventory }, { merge: true });
                }

                showLoading(false);
                goToPage('page-main-menu');

            } catch (error) {
                console.error("Erro ao carregar/criar inventário:", error);
                showAlert("Erro ao carregar dados da filial.");
                showLoading(false);
            }
        }
        
        // Etapa 2: Renderiza a página (Estoque, Pedido ou Histórico)
        window.renderPage = (pageId) => {
            if (pageId === 'page-update-stock') {
                renderStockUpdatePage();
            } else if (pageId === 'page-order-form') {
                renderOrderFormPage();
            } else if (pageId === 'page-history') {
                renderHistoryPage();
            }
            goToPage(pageId);
        }

        // Etapa 3A: Renderiza página de "Gerenciar Estoque"
        function renderStockUpdatePage() {
            const container = document.getElementById('stock-list-container');
            container.innerHTML = '';
            const grouped = groupProducts(allProducts);

            Object.keys(grouped).sort().forEach(category => {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'mb-6 border border-gray-200 rounded-lg shadow-sm';
                categoryWrapper.innerHTML = `<h2 class="text-xl font-semibold text-gray-700 bg-gray-100 p-4 rounded-t-lg border-b">${category}</h2>`;
                
                const grid = document.createElement('div');
                grid.className = 'p-4 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4';

                grouped[category].forEach(product => {
                    const data = filialInventory[product.descricao] || { minimo: 0, estoque: 0 };
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex flex-col sm:flex-row justify-between sm:items-center p-3 rounded-md border border-gray-200';
                    itemEl.innerHTML = `
                        <div class="flex-1 mb-2 sm:mb-0 pr-4">
                            <span class="block text-sm font-medium text-gray-900">${product.descricao}</span>
                            <span class="text-xs text-gray-500">${product.marca}</span>
                        </div>
                        <div class="flex gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 text-right">Mínimo</label>
                                <input type="number" min="0" data-desc="${product.descricao}" data-field="minimo"
                                       class="stock-input w-20 p-2 border border-gray-300 rounded-md text-right"
                                       value="${data.minimo}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 text-right">Estoque</label>
                                <input type="number" min="0" data-desc="${product.descricao}" data-field="estoque"
                                       class="stock-input w-20 p-2 border border-gray-300 rounded-md text-right"
                                       value="${data.estoque}">
                            </div>
                        </div>
                    `;
                    grid.appendChild(itemEl);
                });
                categoryWrapper.appendChild(grid);
                container.appendChild(categoryWrapper);
            });
        }
        
        // Etapa 3A: Salva atualizações do Estoque
        window.saveStockUpdates = async () => {
            showLoading(true);
            document.querySelectorAll('input.stock-input').forEach(input => {
                const desc = input.dataset.desc;
                const field = input.dataset.field;
                const value = parseInt(input.value, 10) || 0;
                if (filialInventory[desc]) filialInventory[desc][field] = value;
            });
            
            const inventoryDocPath = `artifacts/${appId}/public/data/inventarios/${selectedFilial}`;
            
            if (isInSimulationMode) {
                console.log("SIMULAÇÃO: Salvando inventário para " + selectedFilial);
                localStorage.setItem(`sim_inventory_${selectedFilial}`, JSON.stringify(filialInventory));
                setTimeout(() => {
                    showLoading(false);
                    showAlert("Estoque de simulação salvo!", 'success', 2000);
                    goToPage('page-main-menu');
                }, 500);
                return;
            }

            try {
                const docRef = doc(db, inventoryDocPath);
                await setDoc(docRef, { produtos: filialInventory }, { merge: true });
                showLoading(false);
                showAlert("Estoque atualizado com sucesso!", 'success', 2000);
                goToPage('page-main-menu');
            } catch (error) {
                console.error("Erro ao salvar inventário:", error);
                showAlert("Erro ao salvar. Tente novamente.", 'error');
                showLoading(false);
            }
        }

        // Etapa 3B: Renderiza página de "Fazer Pedido"
        function renderOrderFormPage() {
            const container = document.getElementById('order-list-container');
            container.innerHTML = '';
            const grouped = groupProducts(allProducts);

            Object.keys(grouped).sort().forEach(category => {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'mb-6 border border-gray-200 rounded-lg shadow-sm';
                categoryWrapper.innerHTML = `<h2 class="text-xl font-semibold text-gray-700 bg-gray-100 p-4 rounded-t-lg border-b">${category}</h2>`;
                
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'p-4 overflow-x-auto';
                
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Mín.</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Sugerido</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd. a Pedir</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                `;

                const tbody = table.querySelector('tbody');
                grouped[category].forEach(product => {
                    const data = filialInventory[product.descricao] || { minimo: 0, estoque: 0 };
                    const sugerido = Math.max(0, data.minimo - data.estoque);
                    const corSugerido = sugerido > 0 ? 'text-red-600 font-bold' : 'text-gray-700';
                    
                    const itemRow = document.createElement('tr');
                    itemRow.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap">
                            <span class="block text-sm font-medium text-gray-900">${product.descricao}</span>
                            <span class="text-xs text-gray-500">${product.marca}</span>
                        </td>
                        <td class="px-2 py-3 whitespace-nowrap text-right text-sm text-gray-700">${data.minimo}</td>
                        <td class="px-2 py-3 whitespace-nowrap text-right text-sm text-gray-700">${data.estoque}</td>
                        <td class="px-2 py-3 whitespace-nowrap text-right text-sm ${corSugerido}">${sugerido}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-right">
                            <input type="number" min="0" data-desc="${product.descricao}"
                                   class="order-quantity w-20 p-2 border border-gray-300 rounded-md text-right"
                                   placeholder="0" value="${currentOrder[product.descricao] || ''}">
                        </td>
                    `;
                    tbody.appendChild(itemRow);
                });
                
                tableWrapper.appendChild(table);
                categoryWrapper.appendChild(tableWrapper);
                container.appendChild(categoryWrapper);
            });
            
            container.querySelectorAll('.order-quantity').forEach(input => {
                input.addEventListener('input', (e) => {
                    const desc = e.target.dataset.desc;
                    const quant = parseInt(e.target.value, 10);
                    if (quant > 0) currentOrder[desc] = quant;
                    else delete currentOrder[desc];
                });
            });
        }
        
        // Etapa 3C: Renderiza página de "Histórico" (Novo)
        async function renderHistoryPage() {
            showLoading(true);
            const container = document.getElementById('history-list-container');
            container.innerHTML = '<p classcode="text-gray-500">Carregando histórico...</p>';
            
            let pedidos = [];
            
            // Lógica de Simulação
            if (isInSimulationMode) {
                console.log("SIMULAÇÃO: Carregando histórico de pedidos...");
                const localData = localStorage.getItem(`sim_orders_${selectedFilial}`);
                pedidos = localData ? JSON.parse(localData) : [];
            } else {
            // Lógica Real do Firebase
                try {
                    const q = query(
                        collection(db, `artifacts/${appId}/public/data/pedidos`), 
                        where('filial', '==', selectedFilial)
                    );
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => {
                        pedidos.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.error("Erro ao buscar histórico:", error);
                    showAlert('Erro ao carregar o histórico.', 'error');
                    container.innerHTML = '<p classcode="text-red-500">Erro ao carregar histórico.</p>';
                    showLoading(false);
                    return;
                }
            }
            
            // Ordena os pedidos (mais recentes primeiro)
            // No Firebase, 'criadoEm' é um Timestamp. Em simulação, é um Date.
            pedidos.sort((a, b) => {
                const dateA = a.criadoEm.toDate ? a.criadoEm.toDate() : new Date(a.criadoEm);
                const dateB = b.criadoEm.toDate ? b.criadoEm.toDate() : new Date(b.criadoEm);
                return dateB - dateA;
            });
            
            showLoading(false);
            
            if (pedidos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">Nenhum pedido encontrado para esta filial.</p>';
                return;
            }
            
            // Renderiza a lista de pedidos
            container.innerHTML = '';
            pedidos.forEach(pedido => {
                const totalItens = (pedido.items || []).length;
                
                const detailsEl = document.createElement('details');
                
                detailsEl.innerHTML = `
                    <summary>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:gap-6">
                            <strong class="text-blue-600">${formatFirebaseDate(pedido.criadoEm)}</strong>
                            <span class="text-sm text-gray-600">${totalItens} itens do catálogo</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="hidden sm:block text-sm font-medium text-gray-700">Ver Detalhes</span>
                            <i data-lucide="chevron-right" class="chevron w-5 h-5 text-gray-500"></i>
                        </div>
                    </summary>
                    <div class="history-content space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800">Itens do Catálogo:</h4>
                        ${ (pedido.items && pedido.items.length > 0) ? `
                            <ul class="list-disc pl-5 space-y-1">
                                ${pedido.items.map(item => `<li><span class="font-medium">${item.quantidade}x</span> - ${item.descricao}</li>`).join('')}
                            </ul>
                        ` : '<p class="text-gray-500">Nenhum item do catálogo neste pedido.</p>' }
                        
                        <h4 class="text-lg font-semibold text-gray-800 mt-4">Itens Extras:</h4>
                        ${ pedido.itensExtras ? `
                            <p class="text-gray-700 bg-gray-50 p-3 rounded-md whitespace-pre-wrap">${pedido.itensExtras}</p>
                        ` : '<p class="text-gray-500">Nenhum item extra neste pedido.</p>' }
                    </div>
                `;
                container.appendChild(detailsEl);
            });
            
            // Recarrega os ícones
            if (window.lucide) {
                lucide.createIcons();
            }
        }
        
        // Etapa 4: Revisa o Pedido
        window.reviewOrder = () => {
            document.querySelectorAll('.order-quantity').forEach(input => {
                const desc = input.dataset.desc;
                const quant = parseInt(input.value, 10);
                if (quant > 0) currentOrder[desc] = quant;
                else delete currentOrder[desc];
            });
            currentExtraItems = document.getElementById('extra-items-textarea').value.trim();

            const summaryContainer = document.getElementById('review-summary');
            summaryContainer.innerHTML = '';
            document.getElementById('review-filial-name').innerText = selectedFilial;

            const itemsToReview = Object.keys(currentOrder).map(desc => ({
                descricao: desc,
                quantidade: currentOrder[desc]
            }));

            if (itemsToReview.length === 0 && !currentExtraItems) {
                showAlert('Você não selecionou nenhum item.', 'error');
                return;
            }

            if(itemsToReview.length > 0) {
                itemsToReview.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between p-2 rounded';
                    itemEl.innerHTML = `
                        <span class="text-gray-700">${item.descricao}</span>
                        <span class="font-bold text-blue-600">${item.quantidade}</span>
                    `;
                    summaryContainer.appendChild(itemEl);
                });
            } else {
                summaryContainer.innerHTML = '<p class="text-gray-500">Nenhum item do catálogo selecionado.</p>';
            }

            const extraContainer = document.getElementById('review-extra-items');
            if (currentExtraItems) {
                extraContainer.innerText = currentExtraItems;
                extraContainer.classList.remove('text-gray-500');
            } else {
                extraContainer.innerText = 'Nenhum item extra adicionado.';
                extraContainer.classList.add('text-gray-500');
            }
            goToPage('page-review');
        }
        
        // Etapa 5: Envia o Pedido
        window.submitOrder = async () => {
            showLoading(true);
            const itemsToSave = Object.keys(currentOrder).map(desc => {
                const product = allProducts.find(p => p.descricao === desc);
                return {
                    descricao: desc,
                    quantidade: currentOrder[desc],
                    categoria: product?.categoria || 'N/A',
                    marca: product?.marca || 'N/A'
                };
            });
            
            const orderData = {
                filial: selectedFilial,
                status: "pendente",
                criadoEm: new Date(), // Em simulação, usamos Date. No Firebase, será Timestamp.
                userId: userId,
                items: itemsToSave,
                itensExtras: currentExtraItems
            };

            // Lógica de Simulação
            if (isInSimulationMode) {
                console.log("SIMULAÇÃO: Pedido enviado", orderData);
                // Salva no histórico de simulação
                const localData = localStorage.getItem(`sim_orders_${selectedFilial}`);
                let pedidos = localData ? JSON.parse(localData) : [];
                pedidos.push(orderData);
                localStorage.setItem(`sim_orders_${selectedFilial}`, JSON.stringify(pedidos));
                
                setTimeout(() => {
                    showLoading(false);
                    currentOrder = {};
                    currentExtraItems = "";
                    document.getElementById('extra-items-textarea').value = "";
                    goToPage('page-success');
                }, 800);
                return;
            }

            // Lógica Real do Firebase
            if (!isAuthReady || !db) {
                showLoading(false);
                showAlert("Erro de conexão.", 'error');
                return;
            }

            // Converte para Timestamp do Firebase
            orderData.criadoEm = Timestamp.now(); 

            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/pedidos`), orderData);
                console.log("Pedido salvo com ID: ", docRef.id);
                showLoading(false);
                currentOrder = {};
                currentExtraItems = "";
                document.getElementById('extra-items-textarea').value = "";
                goToPage('page-success');
            } catch (error) {
                console.error("Erro ao salvar o pedido: ", error);
                showLoading(false);
                showAlert("Ocorreu um erro ao salvar seu pedido.", 'error');
            }
        }

        // --- Inicialização da Aplicação ---
        function initializeAppLogic() {
            if (!firebaseConfig.apiKey) {
                console.warn("Nenhuma config do Firebase. Entrando em modo de simulação.");
                isInSimulationMode = true;
                document.getElementById('simulation-banner').classList.remove('hidden');
                userId = 'simulated-user-' + Date.now();
                isAuthReady = true;
                showLoading(false);
                goToPage(currentPage);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Usuário autenticado:", user.uid);
                        userId = user.uid;
                        isAuthReady = true;
                        if(currentPage === 'page-select-filial' || currentPage === 'page-login') {
                            showLoading(false);
                            goToPage(currentPage);
                        }
                    } else {
                        console.log("Nenhum usuário logado, tentando autenticação...");
                        try {
                            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                            else await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Erro na autenticação:", error);
                            document.getElementById('loading-spinner').innerHTML = '<p class="text-red-500">Erro fatal de autenticação.</p>';
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                document.getElementById('loading-spinner').innerHTML = '<p class="text-red-500">Erro ao carregar a aplicação.</p>';
            }
        }
        
        initializeAppLogic();
    </script>
</body>
</html>