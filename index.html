<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pedidos OdontoCompany</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-icons"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); /* Gradiente sutil de fundo */
            background-attachment: fixed;
        }

        /* Animação de entrada suave */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .page {
            display: none;
        }

        /* Badges de Status Modernos */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .status-pendente { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .status-aprovado { background-color: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
        .status-rejeitado { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }

        /* Inputs Modernos */
        .input-modern {
            transition: all 0.2s;
            background-color: #f9fafb;
        }
        .input-modern:focus {
            background-color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Impressão */
        @media print {
            body { background: white; }
            body > * { display: none !important; }
            #print-area, #print-area * { display: block !important; visibility: visible !important; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; color: #000; }
            .print-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .print-table th { background-color: #f3f4f6; font-weight: bold; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen">

    <div id="app" class="w-full relative">

        <div id="page-select-filial" class="page flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
            <div class="w-full max-w-md bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl border border-white/50 p-8 transform transition-all">
                <div class="flex flex-col items-center mb-8">
                    <div class="bg-blue-50 p-4 rounded-full shadow-inner mb-4">
                        <svg class="h-12 w-12 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-1 4h1m-1 4h1m4-8h1m-1 4h1m-1 4h1" />
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Portal de Pedidos</h1>
                    <p class="text-gray-500 mt-2">Identifique-se para continuar</p>
                </div>
                
                <div class="space-y-3">
                    <button onclick="goToLogin('Patos de Minas')" class="group w-full flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:ring-1 hover:ring-blue-500 transition-all duration-200">
                        <span class="font-semibold text-gray-700 group-hover:text-blue-700">Patos de Minas</span>
                        <i data-lucide="chevron-right" class="text-gray-400 group-hover:text-blue-600"></i>
                    </button>
                    <button onclick="goToLogin('São Gotardo')" class="group w-full flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:ring-1 hover:ring-blue-500 transition-all duration-200">
                        <span class="font-semibold text-gray-700 group-hover:text-blue-700">São Gotardo</span>
                        <i data-lucide="chevron-right" class="text-gray-400 group-hover:text-blue-600"></i>
                    </button>
                    <button onclick="goToLogin('Ibiá')" class="group w-full flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:ring-1 hover:ring-blue-500 transition-all duration-200">
                        <span class="font-semibold text-gray-700 group-hover:text-blue-700">Ibiá</span>
                        <i data-lucide="chevron-right" class="text-gray-400 group-hover:text-blue-600"></i>
                    </button>
                    <button onclick="goToLogin('Guarda dos Ferreiros')" class="group w-full flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md hover:border-blue-500 hover:ring-1 hover:ring-blue-500 transition-all duration-200">
                        <span class="font-semibold text-gray-700 group-hover:text-blue-700">Guarda dos Ferreiros</span>
                        <i data-lucide="chevron-right" class="text-gray-400 group-hover:text-blue-600"></i>
                    </button>
                </div>

                <div class="text-center mt-8 pt-6 border-t border-gray-100">
                    <a href="#" onclick="goToAdminLogin()" class="text-sm font-medium text-gray-400 hover:text-blue-600 transition-colors flex justify-center items-center gap-2">
                        <i data-lucide="lock" class="w-3 h-3"></i> Acesso Administrativo
                    </a>
                </div>
            </div>
        </div>

        <div id="page-login" class="page flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
            <div class="w-full max-w-sm bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8 relative">
                <button onclick="goToPage('page-select-filial')" class="absolute top-4 left-4 text-gray-400 hover:text-blue-600 transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div class="text-center mb-8 mt-2">
                    <h2 class="text-2xl font-bold text-gray-800">Login da Filial</h2>
                    <p class="text-blue-600 font-semibold mt-1" id="login-filial-name"></p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="filial-password" placeholder="Digite sua senha" class="input-modern w-full border border-gray-300 rounded-xl p-4 text-center text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    <button onclick="handleFilialLogin()" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white text-lg font-bold py-3 px-6 rounded-xl shadow-lg transform hover:-translate-y-0.5 transition-all">
                        Acessar Sistema
                    </button>
                </div>
            </div>
        </div>
        
        <div id="page-admin-login" class="page flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
            <div class="w-full max-w-sm bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-8 relative border-t-4 border-red-500">
                <button onclick="goToPage('page-select-filial')" class="absolute top-4 left-4 text-gray-400 hover:text-red-600 transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div class="text-center mb-8 mt-2">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-100 text-red-600 mb-4">
                        <i data-lucide="shield-alert" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Área Restrita</h2>
                    <p class="text-gray-500 text-sm">Apenas administradores</p>
                </div>
                <input type="password" id="admin-password" placeholder="Senha Mestre" class="input-modern w-full border border-gray-300 rounded-xl p-4 text-center text-lg mb-4 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none">
                <button onclick="handleAdminLogin()" class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white text-lg font-bold py-3 px-6 rounded-xl shadow-lg transform hover:-translate-y-0.5 transition-all">
                    Entrar como Admin
                </button>
            </div>
        </div>

        <div id="page-menu" class="page container mx-auto p-4 md:p-8 max-w-5xl animate-fade-in">
            <header class="bg-white/80 backdrop-blur rounded-2xl shadow-sm p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 border border-white/50">
                <div>
                    <p class="text-sm text-gray-500 font-medium uppercase tracking-wide">Painel de Controle</p>
                    <h1 class="text-3xl font-bold text-gray-800"><span id="menu-filial-name" class="text-blue-600"></span></h1>
                </div>
                <button onclick="logout()" class="flex items-center text-gray-500 hover:text-red-600 font-medium transition-colors px-4 py-2 rounded-lg hover:bg-red-50">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Sair
                </button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col items-center text-center hover:shadow-2xl transition-all duration-300 group border border-transparent hover:border-blue-100">
                    <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                        <i data-lucide="package" class="h-8 w-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Meu Estoque</h2>
                    <p class="text-gray-500 mb-8">Gerencie produtos e quantidades mínimas.</p>
                    <button onclick="goToPage('page-manage-stock')" class="w-full text-blue-600 bg-blue-50 hover:bg-blue-600 hover:text-white py-3 px-4 rounded-xl font-bold transition-all">
                        Acessar Estoque
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col items-center text-center hover:shadow-2xl transition-all duration-300 group border border-transparent hover:border-green-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl">NOVO</div>
                    <div class="w-16 h-16 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                        <i data-lucide="shopping-cart" class="h-8 w-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Fazer Pedido</h2>
                    <p class="text-gray-500 mb-8">Gere pedidos automáticos baseados no estoque.</p>
                    <button onclick="goToPage('page-order-form')" class="w-full text-white bg-green-600 hover:bg-green-700 py-3 px-4 rounded-xl font-bold transition-all shadow-md transform hover:-translate-y-1">
                        Iniciar Pedido
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col md:flex-row items-center justify-between gap-6 md:col-span-2 hover:shadow-xl transition-shadow border border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center">
                            <i data-lucide="history" class="h-6 w-6"></i>
                        </div>
                        <div class="text-center md:text-left">
                            <h2 class="text-xl font-bold text-gray-800">Histórico de Pedidos</h2>
                            <p class="text-gray-500 text-sm">Visualize status e pedidos antigos.</p>
                        </div>
                    </div>
                    <button onclick="renderHistory()" class="px-6 py-2 text-purple-600 font-semibold hover:bg-purple-50 rounded-lg transition-colors">
                        Visualizar Histórico &rarr;
                    </button>
                </div>
            </div>
        </div>

        <div id="page-manage-stock" class="page container mx-auto p-4 md:p-8 max-w-6xl animate-fade-in">
            <div class="flex items-center mb-6">
                <button onclick="goToPage('page-menu')" class="mr-4 p-2 rounded-full hover:bg-white hover:shadow transition-all text-gray-600">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">Estoque: <span id="stock-filial-name" class="text-blue-600"></span></h1>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                <div class="p-6 bg-gray-50 border-b border-gray-200 flex flex-col md:flex-row gap-4 justify-between items-center">
                    <div class="relative w-full md:w-96">
                        <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                        <input type="text" id="stock-search" onkeyup="filterTable('stock-search', 'stock-table-body')" placeholder="Buscar produto..." class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                    </div>
                    <button onclick="openAddProductModal()" class="flex items-center bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl font-semibold shadow-md transition-all transform hover:-translate-y-0.5">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Novo Produto
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Produto</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Mínimo</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Atual</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body" class="bg-white divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
                
                <div class="p-6 bg-gray-50 border-t border-gray-200">
                    <button onclick="saveStock()" class="w-full md:w-auto md:float-right bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 px-8 rounded-xl shadow-lg transition-all flex items-center justify-center">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i> Salvar Alterações
                    </button>
                    <div class="clear-both"></div>
                </div>
            </div>
        </div>

        <div id="page-order-form" class="page container mx-auto p-4 md:p-8 max-w-6xl animate-fade-in">
            <div class="flex items-center mb-6">
                <button onclick="goToPage('page-menu')" class="mr-4 p-2 rounded-full hover:bg-white hover:shadow transition-all text-gray-600">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">Novo Pedido</h1>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 mb-8">
                <div class="p-6 bg-blue-50 border-b border-blue-100">
                     <div class="relative w-full">
                        <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                        <input type="text" id="order-search" onkeyup="filterTable('order-search', 'order-table-body')" placeholder="Filtrar lista de pedidos..." class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Produto</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Mín</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Estoque</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-red-500 uppercase">Sugerido</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-green-600 uppercase">Pedir</th>
                            </tr>
                        </thead>
                        <tbody id="order-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-blue-500"></i> Itens Extras / Observações
                </h3>
                <p class="text-sm text-gray-500 mb-3">Liste itens fora do catálogo ou observações específicas.</p>
                <textarea id="extra-items-textarea" rows="4" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-gray-50" placeholder="Ex: 5x Máscaras N95..."></textarea>
            </div>

            <button onclick="reviewOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 rounded-xl shadow-xl transition-all transform hover:-translate-y-1 flex items-center justify-center">
                Revisar e Enviar <i data-lucide="arrow-right" class="ml-2 w-6 h-6"></i>
            </button>
        </div>

        <div id="page-review-order" class="page container mx-auto p-4 md:p-8 max-w-3xl animate-fade-in">
            <button onclick="goToPage('page-order-form')" class="mb-6 text-gray-500 hover:text-blue-600 font-medium flex items-center transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> Voltar e Editar
            </button>
            
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-gray-50 p-6 border-b border-gray-200 text-center">
                    <h1 class="text-2xl font-bold text-gray-800">Resumo do Pedido</h1>
                    <p class="text-gray-500 text-sm mt-1">Confira os itens antes de enviar.</p>
                </div>
                
                <div id="review-summary-container" class="p-8">
                    </div>

                <div class="p-6 bg-gray-50 border-t border-gray-200 flex flex-col sm:flex-row gap-4">
                    <button onclick="printOrder(currentOrder, currentExtraItems)" class="w-full sm:w-auto flex-1 bg-white border border-blue-600 text-blue-600 font-bold py-3 rounded-xl hover:bg-blue-50 transition-colors flex justify-center items-center shadow-sm">
                        <i data-lucide="printer" class="w-5 h-5 mr-2"></i> Imprimir
                    </button>
                    <button onclick="submitOrder()" class="w-full sm:w-auto flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all transform hover:-translate-y-0.5 flex justify-center items-center">
                        <i data-lucide="send" class="w-5 h-5 mr-2"></i> Confirmar Envio
                    </button>
                </div>
            </div>
        </div>

        <div id="page-history" class="page container mx-auto p-4 md:p-8 max-w-5xl animate-fade-in">
            <div class="flex items-center mb-8">
                <button onclick="goToPage('page-menu')" class="mr-4 p-2 rounded-full hover:bg-white hover:shadow transition-all text-gray-600">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">Histórico de Pedidos</h1>
            </div>
            
            <div id="history-list-container" class="space-y-6">
                </div>
        </div>
        
        <div id="page-admin-panel" class="page container mx-auto p-4 md:p-8 max-w-6xl animate-fade-in">
            <header class="bg-white/80 backdrop-blur rounded-2xl shadow-sm p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 border border-red-100">
                <div class="flex items-center gap-4">
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                        <i data-lucide="shield" class="h-6 w-6 text-red-600"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-red-600">Painel Administrativo</h1>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-red-600 font-medium transition-colors">Sair</button>
            </header>
            
            <div class="bg-white rounded-2xl shadow-xl min-h-[400px] p-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i data-lucide="inbox" class="w-6 h-6 mr-2 text-yellow-500"></i> Pedidos Pendentes
                </h2>
                
                <div id="admin-list-container" class="space-y-6">
                    <p id="no-pending-orders" class="text-gray-400 text-center text-lg py-12 flex flex-col items-center">
                        <i data-lucide="check-circle" class="w-12 h-12 mb-2 text-gray-200"></i>
                        Nenhum pedido pendente.
                    </p>
                </div>
            </div>
        </div>

    </div> 

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[9998]" style="display: none;">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-blue-800 font-semibold animate-pulse">Carregando...</p>
        </div>
    </div>

    <div id="alert-box" class="fixed top-6 right-6 z-[9999] hidden animate-fade-in" style="display: none;">
        <div class="bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center border border-gray-700">
            <i data-lucide="info" class="w-6 h-6 mr-3 text-blue-400"></i>
            <span id="alert-message" class="font-medium"></span>
        </div>
    </div>

    <div id="print-area" class="hidden"></div>
    
    <div id="modal-admin-edit" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[9990] hidden" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col animate-fade-in">
            <header class="flex justify-between items-center p-6 border-b border-gray-100">
                <h2 class="text-xl font-bold text-gray-800">Editar Pedido</h2>
                <button onclick="closeEditModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" class="h-6 w-6 text-gray-500"></i></button>
            </header>
            <div id="modal-edit-content" class="p-6 overflow-y-auto custom-scrollbar">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Itens Principais</h3>
                <div id="modal-edit-items-table" class="mb-6 bg-gray-50 rounded-xl p-4"></div>
                
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Observações / Extras</h3>
                <textarea id="modal-edit-extra-items" rows="4" class="w-full border border-gray-300 rounded-xl p-4 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <footer class="p-6 bg-gray-50 border-t border-gray-100 flex justify-end gap-3 rounded-b-2xl">
                <button onclick="closeEditModal()" class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-colors">Cancelar</button>
                <button onclick="saveOrderEdit()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-md transition-colors">Salvar e Aprovar</button>
            </footer>
        </div>
    </div>
    
    <div id="modal-add-product" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[9990] hidden" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fade-in">
            <header class="flex justify-between items-center p-6 border-b border-gray-100">
                <h2 class="text-xl font-bold text-gray-800">Novo Produto</h2>
                <button onclick="closeAddProductModal()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="h-6 w-6 text-gray-500"></i></button>
            </header>
            <div class="p-8 space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descrição</label>
                    <input type="text" id="new-prod-desc" placeholder="Ex: Resina Z350" class="input-modern w-full border border-gray-300 rounded-xl p-3 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Categoria</label>
                    <input type="text" id="new-prod-cat" placeholder="Ex: Dentística" class="input-modern w-full border border-gray-300 rounded-xl p-3 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Marca</label>
                    <input type="text" id="new-prod-marca" placeholder="Ex: 3M" class="input-modern w-full border border-gray-300 rounded-xl p-3 outline-none">
                </div>
            </div>
            <footer class="p-6 bg-gray-50 border-t border-gray-100 flex justify-end gap-3 rounded-b-2xl">
                <button onclick="closeAddProductModal()" class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl">Cancelar</button>
                <button onclick="addNewProduct()" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg">Adicionar</button>
            </footer>
        </div>
    </div>
    
    <div id="modal-confirm" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[10000] hidden" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-fade-in">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600"></i>
            </div>
            <h2 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2">Confirmar?</h2>
            <p id="confirm-message" class="text-gray-500 mb-6">Tem certeza que deseja prosseguir?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirmModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200">Cancelar</button>
                <button id="confirm-button" class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 shadow-md">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAL6YINzFkB-5km3tGDRca9N3huq03t6Vs",
            authDomain: "controle-odonto.firebaseapp.com",
            projectId: "controle-odonto",
            storageBucket: "controle-odonto.firebasestorage.app",
            messagingSenderId: "602842360218",
            appId: "1:602842360218:web:bad33a20132246af65f223"
        };
        
        const isInSimulationMode = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'odonto-app-v1';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const FILIAL_PASSWORDS = {
            'Patos de Minas': '123',
            'São Gotardo': '123',
            'Ibiá': '123',
            'Guarda dos Ferreiros': '123'
        };
        const ADMIN_PASSWORD = 'admin123';

        let app, db, auth, userId;
        let selectedFilial = null;
        let filialInventory = {};
        let currentPage = 'page-select-filial';
        let currentOrder = {};
        let currentExtraItems = "";
        let adminEditingOrderId = null;
        let confirmCallback = null;

        const INITIAL_CATALOG = {
            "Ácido Fluorídrico": { cat: "DENTÍSTICA", marca: "ALLPRIME", min: {"Ibiá": 2} },
            "Ácido Fosfórico 37%": { cat: "DENTÍSTICA", marca: "ALLPRIME", min: {"Ibiá": 7} },
            "Acrílica AltoPolimerizante 61": { cat: "DENTÍSTICA", marca: "DENCOR", min: {"Ibiá": 1} },
            "AGULHA CURTA": { cat: "DIVERSOS", marca: "ALLPRIME", min: {"Ibiá": 2, "Guarda dos Ferreiros": 2, "Patos de Minas": 2} },
            "AGULHA LONGA": { cat: "DIVERSOS", marca: "ALLPRIME", min: {"Ibiá": 1, "Guarda dos Ferreiros": 2, "Patos de Minas": 1} },
            "ALGINATO ALVAGEL": { cat: "DIVERSOS", marca: "DENTSPLY", min: {"Ibiá": 3} },
            "ALGODAO ROLETE": { cat: "DIVERSOS", marca: "SSPLUS", min: {"Ibiá": 15} },
            "ALPHACAINA": { cat: "CIRURGIA", marca: "DFL", min: {"Guarda dos Ferreiros": 3, "São Gotardo": 3, "Patos de Minas": 4} },
            "ARTICAINE": { cat: "CIRURGIA", marca: "DFL", min: {"Guarda dos Ferreiros": 3, "São Gotardo": 3} },
            "BENSONTOP - ANESTÉSICO TÓPICO": { cat: "CIRURGIA", marca: "DFL", min: {"Guarda dos Ferreiros": 2} },
            "FIO DE SUTURA 3-0 NYLON": { cat: "CIRURGIA", marca: "PROCARE", min: {"Guarda dos Ferreiros": 3} },
            "FIO DE SUTURA 4-0 NYLON": { cat: "CIRURGIA", marca: "PROCARE", min: {"Guarda dos Ferreiros": 3, "São Gotardo": 5, "Patos de Minas": 2} },
            "HEMOSPOM": { cat: "CIRURGIA", marca: "MAQUIRA", min: {"Guarda dos Ferreiros": 1, "São Gotardo": 1} },
            "LÂMINA DE BISTURI Nº12": { cat: "CIRURGIA", marca: "SOLIDOR", min: {"Guarda dos Ferreiros": 1, "Patos de Minas": 2} },
            "LÂMINA DE BISTURI Nº15": { cat: "CIRURGIA", marca: "SOLIDOR", min: {"Guarda dos Ferreiros": 1, "São Gotardo": 3, "Patos de Minas": 3} },
            "LIDOSTESIN (LIDOCAIÍNA)": { cat: "CIRURGIA", marca: "SSWHITE", min: {"Guarda dos Ferreiros": 5} },
            "LIDOSTESIN": { cat: "CIRURGIA", marca: "SSPLUS", min: {"São Gotardo": 8} },
            "SORO FISIOLOGICO 500ML": { cat: "CIRURGIA", marca: "-", min: {"São Gotardo": 10} },
            "SUGADOR CIRURGICO caixa com 40 unidades": { cat: "CIRURGIA", marca: "MAQUIRA", min: {"São Gotardo": 3} },
            "BENSONTOP": { cat: "CIRURGIA", marca: "DFL", min: {"São Gotardo": 2, "Patos de Minas": 3} },
            "ANESTÉSICO ARTICAINE": { cat: "CIRURGIA", marca: "DFL", min: {"Patos de Minas": 3} },
            "FIO DE SUTURA 3-0 NLON": { cat: "CIRURGIA", marca: "PROCARE", min: {"Patos de Minas": 4} },
            "HEMOLIQ": { cat: "CIRURGIA", marca: "MAQUIRA", min: {"Patos de Minas": 2} },
            "BRACKET ROTH 0,22": { cat: "ORTODONTIA", marca: "MORELLI", min: {} },
            "FIO NITI 12 SUPERIOR": { cat: "ORTODONTIA", marca: "MORELLI", min: {} },
            "FIO NITI 14 INFERIOR": { cat: "ORTODONTIA", marca: "MORELLI", min: {} }
        };

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function showAlert(message, duration = 3000) {
            const alertBox = document.getElementById('alert-box');
            document.getElementById('alert-message').textContent = message;
            alertBox.style.display = 'flex';
            setTimeout(() => { alertBox.style.display = 'none'; }, duration);
        }

        window.goToPage = (pageId) => {
            document.querySelectorAll('#app > .page').forEach(page => page.style.display = 'none');
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = targetPage.classList.contains('flex') ? 'flex' : 'block';
            }
            currentPage = pageId;
            window.scrollTo(0, 0);
            if (window.lucide) lucide.createIcons();
            if (pageId === 'page-manage-stock') renderStockTable();
            if (pageId === 'page-order-form') renderOrderTable();
        }

        function groupProducts(productList) {
            const grouped = {};
            productList.forEach(prod => {
                const cat = prod.categoria || 'DIVERSOS';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(prod);
            });
            return Object.keys(grouped).sort().reduce((obj, key) => { obj[key] = grouped[key]; return obj; }, {});
        }

        window.filterTable = (inputId, tableBodyId) => {
            const filter = document.getElementById(inputId).value.toUpperCase();
            const tableBody = document.getElementById(tableBodyId);
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row.classList.contains('category-header')) { row.style.display = ""; } 
                else {
                    const productNameCell = row.getElementsByTagName('td')[0];
                    if (productNameCell) {
                        const productName = productNameCell.textContent || productNameCell.innerText;
                        row.style.display = productName.toUpperCase().indexOf(filter) > -1 ? "" : "none";
                    }
                }
            }
        }
        
        async function initializeFirebase() {
            if (isInSimulationMode) {
                showLoading(false);
                goToPage('page-select-filial');
                return;
            }
            try {
                showLoading(true);
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        showLoading(false);
                        goToPage('page-select-filial');
                    } else {
                        showAlert("Erro ao conectar.");
                    }
                });
            } catch (error) {
                console.error("Erro Firebase:", error);
                showAlert("Erro crítico ao carregar a aplicação.");
            }
        }

        window.goToLogin = (filial) => {
            selectedFilial = filial;
            document.getElementById('login-filial-name').textContent = filial;
            document.getElementById('filial-password').value = "";
            goToPage('page-login');
        }

        window.handleFilialLogin = () => {
            const pass = document.getElementById('filial-password').value;
            if (pass === FILIAL_PASSWORDS[selectedFilial]) {
                document.getElementById('menu-filial-name').textContent = selectedFilial;
                document.getElementById('stock-filial-name').textContent = selectedFilial;
                document.getElementById('order-filial-name').textContent = selectedFilial;
                loadFilialData();
                goToPage('page-menu');
            } else {
                showAlert("Senha incorreta!");
            }
        }
        
        window.goToAdminLogin = () => {
            document.getElementById('admin-password').value = "";
            goToPage('page-admin-login');
        }

        window.handleAdminLogin = () => {
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASSWORD) {
                loadAdminPanel();
                goToPage('page-admin-panel');
            } else {
                showAlert("Senha incorreta!");
            }
        }

        window.logout = () => {
            selectedFilial = null;
            filialInventory = {};
            currentOrder = {};
            currentExtraItems = "";
            goToPage('page-select-filial');
        }

        async function loadFilialData() {
            showLoading(true);
            currentOrder = {};
            currentExtraItems = "";
            document.getElementById('extra-items-textarea').value = "";
            const inventoryDocPath = `artifacts/${appId}/public/data/inventarios/${selectedFilial}`;
            
            if (isInSimulationMode) {
                const localData = localStorage.getItem(`sim_inventory_${selectedFilial}`);
                filialInventory = localData ? JSON.parse(localData) : {};
                if (!localData) {
                    for (const desc in INITIAL_CATALOG) {
                        const item = INITIAL_CATALOG[desc];
                        filialInventory[desc] = { descricao: desc, categoria: item.cat || 'DIVERSOS', marca: item.marca || '', minimo: item.min[selectedFilial] || 0, estoque: 0 };
                    }
                }
                setTimeout(() => { showLoading(false); }, 500);
                return;
            }

            try {
                const docRef = doc(db, inventoryDocPath);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    filialInventory = docSnap.data().produtos || {};
                } else {
                    filialInventory = {};
                    for (const desc in INITIAL_CATALOG) {
                        const item = INITIAL_CATALOG[desc];
                        filialInventory[desc] = { descricao: desc, categoria: item.cat || 'DIVERSOS', marca: item.marca || '', minimo: item.min[selectedFilial] || 0, estoque: 0 };
                    }
                    await setDoc(docRef, { filial: selectedFilial, produtos: filialInventory, criadoEm: Timestamp.now() });
                }
            } catch (error) {
                console.error(error);
                showAlert("Erro ao carregar dados do inventário.");
            } finally {
                showLoading(false);
            }
        }

        function renderStockTable() {
            const tableBody = document.getElementById('stock-table-body');
            tableBody.innerHTML = '';
            
            const productsToList = Object.values(filialInventory).sort((a,b) => a.descricao.localeCompare(b.descricao));
            const groupedProducts = groupProducts(productsToList);

            if (productsToList.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500 italic">Nenhum produto cadastrado.</td></tr>`;
                 return;
            }

            for (const categoria in groupedProducts) {
                tableBody.innerHTML += `<tr class="bg-gray-100 category-header sticky top-0"><td colspan="4" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">${categoria}</td></tr>`;
                groupedProducts[categoria].forEach(prod => {
                    tableBody.innerHTML += `
                        <tr data-product-name="${prod.descricao}" class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${prod.descricao}</div>
                                <div class="text-xs text-gray-500">${prod.marca || 'Sem marca'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <input type="number" min="0" value="${prod.minimo}" class="stock-minimo w-20 bg-white border border-gray-300 rounded-lg p-2 text-center focus:ring-2 focus:ring-blue-500 outline-none" data-product="${prod.descricao}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <input type="number" min="0" value="${prod.estoque}" class="stock-estoque w-20 bg-white border border-gray-300 rounded-lg p-2 text-center focus:ring-2 focus:ring-blue-500 outline-none" data-product="${prod.descricao}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button onclick="confirmRemoveProduct('${prod.descricao}')" class="text-gray-400 hover:text-red-600 transition-colors p-2 rounded-full hover:bg-red-50">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            lucide.createIcons();
        }

        window.saveStock = async () => {
            showLoading(true);
            document.querySelectorAll('#stock-table-body .stock-minimo').forEach(input => {
                if (filialInventory[input.dataset.product]) filialInventory[input.dataset.product].minimo = parseInt(input.value) || 0;
            });
            document.querySelectorAll('#stock-table-body .stock-estoque').forEach(input => {
                 if (filialInventory[input.dataset.product]) filialInventory[input.dataset.product].estoque = parseInt(input.value) || 0;
            });
            
            const inventoryDocPath = `artifacts/${appId}/public/data/inventarios/${selectedFilial}`;
            if (isInSimulationMode) {
                localStorage.setItem(`sim_inventory_${selectedFilial}`, JSON.stringify(filialInventory));
                setTimeout(() => { showLoading(false); showAlert("Salvo (simulação)!", 2000); goToPage('page-menu'); }, 500);
                return;
            }
            try {
                await setDoc(doc(db, inventoryDocPath), { produtos: filialInventory }, { merge: true });
                showAlert("Estoque atualizado!", 2000);
                goToPage('page-menu');
            } catch (error) {
                console.error(error); showAlert("Erro ao salvar.");
            } finally {
                showLoading(false);
            }
        }

        window.openAddProductModal = () => {
            document.getElementById('new-prod-desc').value = "";
            document.getElementById('new-prod-cat').value = "";
            document.getElementById('new-prod-marca').value = "";
            document.getElementById('modal-add-product').style.display = 'flex';
        }
        window.closeAddProductModal = () => document.getElementById('modal-add-product').style.display = 'none';

        window.addNewProduct = async () => {
            const desc = document.getElementById('new-prod-desc').value.trim();
            const cat = document.getElementById('new-prod-cat').value.trim() || 'DIVERSOS';
            const marca = document.getElementById('new-prod-marca').value.trim() || 'Sem Marca';
            if (!desc) return showAlert("Descrição obrigatória.");
            if (filialInventory[desc]) return showAlert("Produto já existe.");
            
            filialInventory[desc] = { descricao: desc, categoria: cat, marca: marca, minimo: 0, estoque: 0 };
            
            showLoading(true);
            const inventoryDocPath = `artifacts/${appId}/public/data/inventarios/${selectedFilial}`;

            if (isInSimulationMode) {
                localStorage.setItem(`sim_inventory_${selectedFilial}`, JSON.stringify(filialInventory));
            } else {
                try {
                    await setDoc(doc(db, inventoryDocPath), { produtos: filialInventory }, { merge: true });
                } catch (error) {
                    delete filialInventory[desc]; showLoading(false); return showAlert("Erro ao salvar.");
                }
            }
            showLoading(false);
            closeAddProductModal();
            renderStockTable();
            showAlert("Produto adicionado!", 2000);
        }
        
        window.confirmRemoveProduct = (productName) => {
            openConfirmModal(`Remover "${productName}"?`, `Tem certeza que deseja remover este produto?`, "Sim, Remover", () => removeProduct(productName));
        }

        async function removeProduct(productName) {
            delete filialInventory[productName];
            showLoading(true);
            const inventoryDocPath = `artifacts/${appId}/public/data/inventarios/${selectedFilial}`;
            if (isInSimulationMode) {
                localStorage.setItem(`sim_inventory_${selectedFilial}`, JSON.stringify(filialInventory));
            } else {
                try {
                    await setDoc(doc(db, inventoryDocPath), { produtos: filialInventory }, { merge: true });
                } catch (error) { showLoading(false); return showAlert("Erro ao remover."); }
            }
            showLoading(false); renderStockTable(); showAlert("Produto removido!", 2000);
        }

        window.openConfirmModal = (title, message, confirmText, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-button').textContent = confirmText;
            confirmCallback = onConfirm;
            document.getElementById('modal-confirm').style.display = 'flex';
        }
        window.closeConfirmModal = () => {
            document.getElementById('modal-confirm').style.display = 'none';
            confirmCallback = null;
        }
        window.handleConfirm = () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        }
        
        function renderOrderTable() {
            const tableBody = document.getElementById('order-table-body');
            tableBody.innerHTML = '';
            
            const productsToList = Object.values(filialInventory).sort((a,b) => a.descricao.localeCompare(b.descricao));
            const groupedProducts = groupProducts(productsToList);
            
            if (productsToList.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">Nenhum produto cadastrado.</td></tr>`;
                 return;
            }

            for (const categoria in groupedProducts) {
                tableBody.innerHTML += `<tr class="bg-gray-100 category-header sticky top-0"><td colspan="5" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">${categoria}</td></tr>`;
                groupedProducts[categoria].forEach(prod => {
                    const sugerido = Math.max(0, prod.minimo - prod.estoque);
                    tableBody.innerHTML += `
                        <tr data-product-name="${prod.descricao}" class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${prod.descricao}</div>
                                <div class="text-xs text-gray-500">${prod.marca || 'Sem marca'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-700">${prod.minimo}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-700">${prod.estoque}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold ${sugerido > 0 ? 'text-red-600' : 'text-gray-400'}">${sugerido}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <input type="number" min="0" value="${sugerido}" class="order-quantity w-20 bg-white border border-gray-300 rounded-lg p-2 text-center focus:ring-2 focus:ring-green-500 outline-none" data-product="${prod.descricao}">
                            </td>
                        </tr>
                    `;
                });
            }
            lucide.createIcons();
        }

        window.reviewOrder = () => {
            currentOrder = {};
            document.querySelectorAll('.order-quantity').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) currentOrder[input.dataset.product] = quantity;
            });
            currentExtraItems = document.getElementById('extra-items-textarea').value;
            const container = document.getElementById('review-summary-container');
            container.innerHTML = `<h2 class="text-2xl font-bold mb-6 text-blue-700 border-b pb-2">Filial: ${selectedFilial}</h2>`;
            
            if (Object.keys(currentOrder).length > 0) {
                let html = '<div class="bg-gray-50 rounded-xl p-4 mb-4"><h3 class="text-sm font-bold text-gray-500 uppercase mb-3">Itens Selecionados</h3><ul class="space-y-2">';
                for (const product in currentOrder) {
                    html += `<li class="flex justify-between items-center border-b border-gray-200 pb-1 last:border-0"><span class="text-gray-700">${product}</span><span class="font-bold bg-white px-2 py-0.5 rounded shadow-sm">${currentOrder[product]} un</span></li>`;
                }
                html += '</ul></div>';
                container.innerHTML += html;
            } else {
                container.innerHTML += '<p class="text-gray-400 italic mb-4">Nenhum item do catálogo selecionado.</p>';
            }
            if (currentExtraItems.trim()) {
                container.innerHTML += `<div class="bg-blue-50 rounded-xl p-4"><h3 class="text-sm font-bold text-blue-600 uppercase mb-2">Extras / Observações</h3><pre class="whitespace-pre-wrap font-sans text-gray-700 text-sm">${currentExtraItems}</pre></div>`;
            }
            goToPage('page-review-order');
        }

        window.submitOrder = async () => {
            showLoading(true);
            const orderData = { filial: selectedFilial, createdAt: isInSimulationMode ? new Date() : Timestamp.now(), items: currentOrder, extraItems: currentExtraItems, status: 'Pendente' };
            const ordersCollectionPath = `artifacts/${appId}/public/data/pedidos`;
            if (isInSimulationMode) {
                let history = JSON.parse(localStorage.getItem(`sim_history_${selectedFilial}`)) || [];
                history.unshift({ ...orderData, id: `sim_${Date.now()}` });
                localStorage.setItem(`sim_history_${selectedFilial}`, JSON.stringify(history));
                setTimeout(() => { showLoading(false); showAlert("Pedido enviado (simulação)!", 2000); goToPage('page-menu'); }, 500);
                return;
            }
            try {
                await addDoc(collection(db, ordersCollectionPath), orderData);
                showAlert("Pedido enviado com sucesso!", 2000);
                goToPage('page-menu');
            } catch (error) { console.error(error); showAlert("Erro ao enviar."); } finally { showLoading(false); }
        }

        window.renderHistory = async () => {
            goToPage('page-history');
            showLoading(true);
            const container = document.getElementById('history-list-container');
            container.innerHTML = '';
            let orderHistory = [];
            const ordersCollectionPath = `artifacts/${appId}/public/data/pedidos`;
            
            if (isInSimulationMode) {
                orderHistory = JSON.parse(localStorage.getItem(`sim_history_${selectedFilial}`)) || [];
                orderHistory.forEach(order => { order.createdAt = new Date(order.createdAt); });
            } else {
                try {
                    const q = query(collection(db, ordersCollectionPath), where("filial", "==", selectedFilial));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => { orderHistory.push({ id: doc.id, ...doc.data() }); });
                    orderHistory.sort((a, b) => b.createdAt - a.createdAt);
                } catch (error) { console.error(error); showLoading(false); return showAlert("Erro ao carregar histórico."); }
            }
            showLoading(false);
            
            if (orderHistory.length === 0) {
                container.innerHTML = '<div class="text-center py-10"><i data-lucide="history" class="w-12 h-12 text-gray-300 mx-auto mb-2"></i><p class="text-gray-500">Nenhum pedido encontrado.</p></div>';
                lucide.createIcons();
                return;
            }
            orderHistory.forEach(order => {
                const date = (order.createdAt instanceof Date) ? order.createdAt : order.createdAt.toDate();
                const formattedDate = date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                const status = order.status || 'Pendente';
                let statusClass = 'status-pendente';
                if (status === 'Aprovado') statusClass = 'status-aprovado';
                else if (status === 'Rejeitado') statusClass = 'status-rejeitado';
                
                let summary = Object.keys(order.items || {}).length + ' itens';
                if (order.extraItems) summary += ' + extras';

                container.innerHTML += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-gray-400 font-medium">${formattedDate}</p>
                                <p class="text-gray-800 font-bold">${summary}</p>
                            </div>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                        <button onclick="printOrderFromHistory('${order.id}')" class="w-full mt-2 text-sm text-blue-600 bg-blue-50 hover:bg-blue-100 py-2 rounded-lg font-semibold transition-colors flex items-center justify-center">
                            <i data-lucide="printer" class="w-4 h-4 mr-2"></i> Detalhes / Imprimir
                        </button>
                    </div>
                `;
            });
            lucide.createIcons();
        }
        
        async function loadAdminPanel() {
            showLoading(true);
            const container = document.getElementById('admin-list-container');
            const noOrdersMsg = document.getElementById('no-pending-orders');
            container.innerHTML = '';
            let allOrders = [];
            const ordersCollectionPath = `artifacts/${appId}/public/data/pedidos`;
            
            if (isInSimulationMode) {
                for (const filial of Object.keys(FILIAL_PASSWORDS)) {
                    const history = JSON.parse(localStorage.getItem(`sim_history_${filial}`)) || [];
                    allOrders.push(...history);
                }
                allOrders.forEach(order => { order.createdAt = new Date(order.createdAt); });
            } else {
                try {
                    const q = query(collection(db, ordersCollectionPath));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => { allOrders.push({ id: doc.id, ...doc.data() }); });
                } catch (error) { showLoading(false); return; }
            }
            allOrders.sort((a, b) => b.createdAt - a.createdAt);
            const pendingOrders = allOrders.filter(order => order.status === 'Pendente');
            showLoading(false);
            
            if (pendingOrders.length === 0) { noOrdersMsg.style.display = 'flex'; return; }
            noOrdersMsg.style.display = 'none';
            
            pendingOrders.forEach(order => {
                const date = (order.createdAt instanceof Date) ? order.createdAt : order.createdAt.toDate();
                const formattedDate = date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                
                let itemsHtml = '<div class="bg-gray-50 rounded-lg p-3 text-sm text-gray-700 mb-4 space-y-1">';
                for (const p in order.items) itemsHtml += `<div class="flex justify-between border-b border-gray-200 last:border-0 pb-1"><span>${p}</span><span class="font-bold">${order.items[p]}</span></div>`;
                if (order.extraItems) itemsHtml += `<div class="mt-2 pt-2 border-t border-gray-200 text-blue-600 font-medium">Extras: ${order.extraItems.substring(0, 50)}...</div>`;
                itemsHtml += '</div>';

                container.innerHTML += `
                    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                        <div class="p-5">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-lg text-gray-800">${order.filial}</h3>
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-md">${formattedDate}</span>
                            </div>
                            ${itemsHtml}
                            <div class="flex gap-2 mt-2">
                                <button onclick="approveOrder('${order.id}')" class="flex-1 bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 rounded-lg transition-colors flex justify-center items-center"><i data-lucide="check" class="w-4 h-4 mr-1"></i> Aprovar</button>
                                <button onclick="openEditModal('${order.id}')" class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-2 rounded-lg transition-colors flex justify-center items-center"><i data-lucide="edit-2" class="w-4 h-4 mr-1"></i> Editar</button>
                                <button onclick="rejectOrder('${order.id}')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 rounded-lg transition-colors flex justify-center items-center"><i data-lucide="x" class="w-4 h-4 mr-1"></i> Rejeitar</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        async function updateOrderStatus(orderId, newStatus, data = {}) {
            showLoading(true);
            const orderDocPath = `artifacts/${appId}/public/data/pedidos/${orderId}`;
            const updateData = { ...data, status: newStatus };
            if (isInSimulationMode) {
                for (const filial of Object.keys(FILIAL_PASSWORDS)) {
                    let history = JSON.parse(localStorage.getItem(`sim_history_${filial}`)) || [];
                    const idx = history.findIndex(o => o.id === orderId);
                    if (idx > -1) {
                        history[idx].status = newStatus;
                        if (data.items) history[idx].items = data.items;
                        if (data.extraItems) history[idx].extraItems = data.extraItems;
                        localStorage.setItem(`sim_history_${filial}`, JSON.stringify(history)); break;
                    }
                }
                setTimeout(() => { showLoading(false); showAlert(`Pedido ${newStatus}!`, 2000); goToPage('page-menu'); }, 500);
                return;
            }
            try {
                await updateDoc(doc(db, orderDocPath), updateData);
                showAlert(`Pedido ${newStatus}!`, 2000);
            } catch (error) { console.error(error); showAlert("Erro ao atualizar."); } finally { showLoading(false); goToPage('page-menu'); }
        }

        window.approveOrder = (id) => updateOrderStatus(id, 'Aprovado');
        window.rejectOrder = (id) => openConfirmModal('Rejeitar?', 'Confirma a rejeição?', 'Rejeitar', () => updateOrderStatus(id, 'Rejeitado'));
        
        window.openEditModal = async (orderId) => {
            showLoading(true); adminEditingOrderId = null; let orderData;
            const orderDocPath = `artifacts/${appId}/public/data/pedidos/${orderId}`;
            if (isInSimulationMode) {
                for (const filial of Object.keys(FILIAL_PASSWORDS)) {
                    let history = JSON.parse(localStorage.getItem(`sim_history_${filial}`)) || [];
                    const found = history.find(o => o.id === orderId); if (found) { orderData = found; break; }
                }
            } else {
                try {
                    const snap = await getDoc(doc(db, orderDocPath));
                    if (snap.exists()) orderData = snap.data();
                } catch (e) { showLoading(false); return; }
            }
            if (!orderData) { showLoading(false); return showAlert("Não encontrado."); }

            const tb = document.getElementById('modal-edit-items-table'); tb.innerHTML = '';
            for (const p in orderData.items) tb.innerHTML += `<div class="flex justify-between items-center mb-2"><span class="text-sm text-gray-700">${p}</span><input type="number" value="${orderData.items[p]}" class="modal-edit-quantity w-16 border rounded p-1 text-center" data-product="${p}"></div>`;
            document.getElementById('modal-edit-extra-items').value = orderData.extraItems || "";
            adminEditingOrderId = orderId; showLoading(false); document.getElementById('modal-admin-edit').style.display = 'flex';
        }
        window.closeEditModal = () => { document.getElementById('modal-admin-edit').style.display = 'none'; adminEditingOrderId = null; }
        window.saveOrderEdit = () => {
            if (!adminEditingOrderId) return;
            const newItems = {};
            document.querySelectorAll('.modal-edit-quantity').forEach(i => { const q = parseInt(i.value)||0; if(q>0) newItems[i.dataset.product] = q; });
            updateOrderStatus(adminEditingOrderId, 'Aprovado', { items: newItems, extraItems: document.getElementById('modal-edit-extra-items').value });
            closeEditModal();
        }

        window.printOrder = (items, extras) => {
            let html = '<div style="margin-bottom: 20px;">';
            html += '<table class="print-table"><thead><tr><th>Produto</th><th>Qtd</th></tr></thead><tbody>';
            if (Object.keys(items).length > 0) { for (const p in items) html += `<tr><td>${p}</td><td>${items[p]}</td></tr>`; } else { html += '<tr><td colspan="2">Sem itens principais.</td></tr>'; }
            html += '</tbody></table></div>';
            if (extras) html += `<div style="background: #f9f9f9; padding: 10px; border: 1px solid #ddd; font-family: sans-serif;"><strong>Extras:</strong><br>${extras}</div>`;
            
            document.getElementById('print-area').innerHTML = `
                <div class="print-header">Pedido OdontoCompany</div>
                <div style="margin-bottom: 10px;"><strong>Filial:</strong> ${selectedFilial}</div>
                <div style="margin-bottom: 20px;"><strong>Data:</strong> ${new Date().toLocaleString()}</div>
                ${html}
            `;
            window.print();
        }
        window.printOrderFromHistory = async (id) => {
            showLoading(true); let orderData;
            const orderDocPath = `artifacts/${appId}/public/data/pedidos/${id}`;
            if (isInSimulationMode) {
                let h = JSON.parse(localStorage.getItem(`sim_history_${selectedFilial}`))||[]; orderData = h.find(o=>o.id===id);
            } else {
                try { const s = await getDoc(doc(db, orderDocPath)); if(s.exists()) orderData = s.data(); } catch (e) {}
            }
            showLoading(false);
            if (orderData) { const oldF = selectedFilial; selectedFilial = orderData.filial; printOrder(orderData.items, orderData.extraItems); selectedFilial = oldF; }
            else showAlert("Erro ao imprimir.");
        }

        document.getElementById('confirm-button').onclick = window.handleConfirm;
        initializeFirebase();
    </script>

</body>
</html>